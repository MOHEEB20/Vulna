<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vulna Dashboard - Real-time Pentest Monitoring</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            overflow-x: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
            padding: 20px;
            border-bottom: 2px solid #00ff00;
            box-shadow: 0 2px 10px rgba(0, 255, 0, 0.2);
        }
        
        .header h1 {
            font-size: 2.5em;
            color: #00ff00;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
            display: inline-block;
        }
        
        .status {
            float: right;
            padding: 10px 20px;
            background: #1a1a1a;
            border-radius: 5px;
            border: 1px solid #00ff00;
        }
        
        .status.connected {
            background: #002200;
            border-color: #00ff00;
        }
        
        .status.disconnected {
            background: #220000;
            border-color: #ff0000;
        }
        
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto 1fr;
            gap: 20px;
            padding: 20px;
            height: calc(100vh - 120px);
        }
        
        .proxy-instructions {
            grid-column: 1 / -1;
            background: #1a1a1a;
            border: 1px solid #00ff00;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .proxy-info {
            flex: 1;
        }
        
        .proxy-info h3 {
            color: #00ff00;
            margin-bottom: 5px;
        }
        
        .proxy-info code {
            background: #2d2d2d;
            padding: 2px 6px;
            border-radius: 3px;
            color: #00ff00;
        }
        
        .browser-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .stats-panel {
            grid-column: 1 / -1;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #00ff00;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            color: #00ff00;
            font-weight: bold;
        }
        
        .stat-label {
            color: #cccccc;
            margin-top: 5px;
        }
        
        .requests-panel, .findings-panel {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .panel-header {
            font-size: 1.5em;
            color: #00ff00;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .request-item, .finding-item {
            background: #2d2d2d;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #666;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .request-item:hover, .finding-item:hover {
            background: #3d3d3d;
            transform: translateX(5px);
        }
        
        .request-item.GET { border-left-color: #00ff00; }
        .request-item.POST { border-left-color: #ffff00; }
        .request-item.PUT { border-left-color: #ff8800; }
        .request-item.DELETE { border-left-color: #ff0000; }
        
        .finding-item.HIGH { border-left-color: #ff0000; }
        .finding-item.MEDIUM { border-left-color: #ffff00; }
        .finding-item.LOW { border-left-color: #00ff00; }
        .finding-item.INFO { border-left-color: #0088ff; }
        
        .request-method {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .method-GET { background: #003300; color: #00ff00; }
        .method-POST { background: #333300; color: #ffff00; }
        .method-PUT { background: #332200; color: #ff8800; }
        .method-DELETE { background: #330000; color: #ff0000; }
        
        .risk-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .risk-HIGH { background: #330000; color: #ff0000; }
        .risk-MEDIUM { background: #333300; color: #ffff00; }
        .risk-LOW { background: #003300; color: #00ff00; }
        .risk-INFO { background: #003333; color: #0088ff; }
        
        .url {
            color: #cccccc;
            word-break: break-all;
        }
        
        .timestamp {
            color: #888;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .finding-title {
            color: #ffffff;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .finding-description {
            color: #cccccc;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        
        .ollama-response {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid #00ff00;
            margin-top: 10px;
            font-family: monospace;
            color: #00ff00;
        }
        
        .controls {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .btn {
            background: #003300;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #00ff00;
            color: #000000;
        }
        
        .btn-browser {
            background: #001133;
            color: #0088ff;
            border: 1px solid #0088ff;
        }
        
        .btn-browser:hover {
            background: #0088ff;
            color: #000000;
        }
        
        .btn-chrome {
            background: #331100;
            color: #ff8800;
            border: 1px solid #ff8800;
        }
        
        .btn-chrome:hover {
            background: #ff8800;
            color: #000000;
        }
        
        .connection-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ff0000;
            transition: background 0.3s ease;
        }
        
        .connection-indicator.connected {
            background: #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #00ff00;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #00cc00;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }
        
        .modal-content {
            background-color: #1a1a1a;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #00ff00;
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #00ff00;
        }
        
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #1a1a1a;
            border: 1px solid #00ff00;
            border-radius: 5px;
            padding: 15px;
            max-width: 400px;
            z-index: 1001;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            white-space: pre-line;
            font-family: monospace;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .notification.success {
            border-color: #00ff00;
            color: #00ff00;
        }
        
        .notification.error {
            border-color: #ff0000;
            color: #ff0000;
        }
    </style>
</head>
<body>
    <div class="connection-indicator" id="connectionIndicator"></div>
    
    <div class="header">
        <h1>VULNA</h1>
        <div class="status" id="statusIndicator">
            <span id="statusText">Connecting...</span>
        </div>
        <div style="clear: both;"></div>
    </div>
    
    <div class="container">
        <div class="proxy-instructions">
            <div class="proxy-info">
                <h3>Proxy Configuration</h3>
                <p>HTTP/HTTPS Proxy: <code>127.0.0.1:8080</code></p>
            </div>
            <div class="browser-controls">
                <button class="btn btn-browser" onclick="startBrowser()">üöÄ Start Browser (Fixed)</button>
                <button class="btn" onclick="testProxy()">üîç Test Proxy</button>
            </div>
        </div>
        
        <div class="stats-panel">
            <div class="panel-header">Live Statistics</div>
            <div class="stats-grid" id="statsGrid">
                <!-- Stats will be populated here -->
            </div>
            <div class="controls">
                <button class="btn" onclick="exportRequests()">Export Requests</button>
                <button class="btn" onclick="exportFindings()">Export Findings</button>
                <button class="btn" onclick="clearData()">Clear Data</button>
                <button class="btn" onclick="refreshData()">Refresh</button>
            </div>
        </div>
        
        <div class="requests-panel">
            <div class="panel-header">HTTP Requests (<span id="requestCount">0</span>)</div>
            <div class="content-area" id="requestsArea">
                <!-- Requests will be populated here -->
            </div>
        </div>
        
        <div class="findings-panel">
            <div class="panel-header">Vulnerabilities (<span id="findingCount">0</span>)</div>
            <div class="content-area" id="findingsArea">
                <!-- Findings will be populated here -->
            </div>
        </div>
    </div>
    
    <!-- Modal for detailed view -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>
    
    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        // WebSocket connection
        let ws = null;
        let reconnectInterval = null;
        
        // Data storage
        let allRequests = [];
        let allFindings = [];
        let stats = {};
        
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('WebSocket connected');
                updateConnectionStatus(true);
                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onclose = function() {
                console.log('WebSocket disconnected');
                updateConnectionStatus(false);
                
                // Auto-reconnect
                if (!reconnectInterval) {
                    reconnectInterval = setInterval(connectWebSocket, 3000);
                }
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateConnectionStatus(false);
            };
        }
        
        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'initial_load':
                    allRequests = data.requests || [];
                    allFindings = data.findings || [];
                    stats = data.stats || {};
                    updateDisplay();
                    break;
                    
                case 'new_requests':
                    allRequests.push(...(data.requests || []));
                    stats = data.stats || stats;
                    updateDisplay();
                    break;
                    
                case 'new_findings':
                    allFindings.push(...(data.findings || []));
                    stats = data.stats || stats;
                    updateDisplay();
                    break;
                    
                case 'browser_started':
                    showNotification(data.message || 'Browser started successfully', 'success');
                    break;
                    
                case 'data_cleared':
                    allRequests = [];
                    allFindings = [];
                    stats = {};
                    updateDisplay();
                    showNotification(data.message || 'Data cleared', 'success');
                    break;
            }
        }
        
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connectionIndicator');
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            if (connected) {
                indicator.classList.add('connected');
                statusIndicator.classList.remove('disconnected');
                statusIndicator.classList.add('connected');
                statusText.textContent = 'Connected';
            } else {
                indicator.classList.remove('connected');
                statusIndicator.classList.remove('connected');
                statusIndicator.classList.add('disconnected');
                statusText.textContent = 'Disconnected';
            }
        }
        
        function updateDisplay() {
            updateStats();
            updateRequests();
            updateFindings();
        }
        
        function updateStats() {
            const statsGrid = document.getElementById('statsGrid');
            const requestCount = document.getElementById('requestCount');
            const findingCount = document.getElementById('findingCount');
            
            requestCount.textContent = allRequests.length;
            findingCount.textContent = allFindings.length;
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total_requests || 0}</div>
                    <div class="stat-label">Total Requests</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.total_findings || 0}</div>
                    <div class="stat-label">Vulnerabilities</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${Object.keys(stats.methods || {}).length}</div>
                    <div class="stat-label">HTTP Methods</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${Object.keys(stats.domains || {}).length}</div>
                    <div class="stat-label">Domains</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${(stats.risks && stats.risks.HIGH) || 0}</div>
                    <div class="stat-label">High Risk</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${new Date(stats.last_updated || Date.now()).toLocaleTimeString()}</div>
                    <div class="stat-label">Last Updated</div>
                </div>
            `;
        }
        
        function updateRequests() {
            const requestsArea = document.getElementById('requestsArea');
            
            // Show latest 100 requests
            const recentRequests = allRequests.slice(-100).reverse();
            
            requestsArea.innerHTML = recentRequests.map(req => `
                <div class="request-item ${req.method}" onclick="showRequestDetails(${JSON.stringify(req).replace(/"/g, '&quot;')})">
                    <span class="request-method method-${req.method}">${req.method}</span>
                    <span class="url">${req.url}</span>
                    <div class="timestamp">${new Date(req.timestamp).toLocaleString()}</div>
                </div>
            `).join('');
        }
        
        function updateFindings() {
            const findingsArea = document.getElementById('findingsArea');
            
            // Show latest 50 findings
            const recentFindings = allFindings.slice(-50).reverse();
            
            findingsArea.innerHTML = recentFindings.map(finding => `
                <div class="finding-item ${finding.risk_level}" onclick="showFindingDetails(${JSON.stringify(finding).replace(/"/g, '&quot;')})">
                    <span class="risk-badge risk-${finding.risk_level}">${finding.risk_level}</span>
                    <div class="finding-title">${finding.title || 'Security Finding'}</div>
                    <div class="finding-description">${finding.description || ''}</div>
                    <div class="timestamp">${new Date(finding.timestamp || Date.now()).toLocaleString()}</div>
                </div>
            `).join('');
        }        
        function showRequestDetails(request) {
            const modal = document.getElementById('detailModal');
            const content = document.getElementById('modalContent');
            
            content.innerHTML = `
                <h2>Request Details</h2>
                <p><strong>Method:</strong> ${request.method}</p>
                <p><strong>URL:</strong> ${request.url}</p>
                <p><strong>Timestamp:</strong> ${new Date(request.timestamp).toLocaleString()}</p>
                
                <h3>Headers</h3>
                <pre style="background: #2d2d2d; padding: 10px; border-radius: 5px; overflow-x: auto;">${JSON.stringify(request.headers, null, 2)}</pre>
                
                ${request.content ? `
                    <h3>Content</h3>
                    <pre style="background: #2d2d2d; padding: 10px; border-radius: 5px; overflow-x: auto; max-height: 200px;">${request.content}</pre>
                ` : ''}
            `;
            
            modal.style.display = 'block';
        }
        
        function showFindingDetails(finding) {
            const modal = document.getElementById('detailModal');
            const content = document.getElementById('modalContent');
            
            // Simple, safe vulnerability details display
            content.innerHTML = `
                <h2>üîí Vulnerability Analysis</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <h3>üìã Basic Information</h3>
                        <p><strong>Title:</strong> ${finding.title || 'Security Finding'}</p>
                        <p><strong>Risk Level:</strong> <span class="risk-badge risk-${finding.risk_level}">${finding.risk_level}</span></p>
                        <p><strong>Risk Score:</strong> ${finding.risk_score || 'N/A'}/10</p>
                        <p><strong>Confidence:</strong> ${Math.round((finding.confidence || 0) * 100)}%</p>
                        <p><strong>Timestamp:</strong> ${new Date(finding.timestamp || Date.now()).toLocaleString()}</p>
                    </div>
                    
                    <div>
                        <h3>üéØ Technical Details</h3>
                        <p><strong>URL:</strong> ${finding.affected_url || finding.url || 'Unknown'}</p>
                        <p><strong>Method:</strong> ${finding.request_method || 'Unknown'}</p>
                        <p><strong>OWASP:</strong> ${(finding.owasp_categories || []).join(', ') || 'Not classified'}</p>
                        <p><strong>CWE:</strong> ${(finding.cwe_ids || []).join(', ') || 'Not classified'}</p>
                        <p><strong>Parameters:</strong> ${(finding.affected_parameters || []).join(', ') || 'None specified'}</p>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3>üìù Description</h3>
                    <div style="background: #2d2d2d; padding: 15px; border-radius: 5px; border-left: 3px solid #00ff00;">
                        ${finding.description || 'No description available'}
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3>üõ†Ô∏è Remediation</h3>
                    <div style="background: #2d2d2d; padding: 15px; border-radius: 5px; border-left: 3px solid #0088ff;">
                        ${finding.suggestion || 'No remediation guidance available'}
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3>ü§ñ AI Actions</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <button class="btn" onclick="generatePoC('${finding.id}')">üî¨ Generate PoC</button>
                        <button class="btn" onclick="openAIChat('${finding.id}')">üí¨ Chat with AI</button>
                        <button class="btn" onclick="autoTestVulnerability('${finding.id}')">‚ö° Auto Test</button>
                        <button class="btn" onclick="openLogView('${finding.id}')">üìä Log View</button>
                        <button class="btn" onclick="analyzeExploitation('${finding.id}')">üîç Analyze Exploitation</button>
                        <button class="btn" onclick="sendVulnToInspector('${finding.id}')" style="background: #0066cc; border-color: #0066cc;">üîç Send to Inspector</button>
                        <button class="btn" onclick="createRequestFromVuln('${finding.id}')" style="background: #0066cc; border-color: #0066cc;">üìù Create Request</button>
                        <button class="btn" onclick="openRequestInspector('${finding.id}')">üîç Request Inspector</button>
                    </div>
                </div>
                
                <div id="aiChatSection" style="display: none; margin-top: 20px;">
                    <h3>üí¨ AI Conversation</h3>
                    <div id="chatHistory" style="background: #1a1a1a; padding: 15px; border-radius: 5px; max-height: 300px; overflow-y: auto; margin-bottom: 10px;">
                        <!-- Chat history will appear here -->
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="chatInput" placeholder="Ask AI about this vulnerability..." 
                               style="flex: 1; padding: 10px; background: #2d2d2d; color: white; border: 1px solid #00ff00; border-radius: 5px;"
                               onkeypress="if(event.key==='Enter') sendAIMessage('${finding.id}')">
                        <button class="btn" onclick="sendAIMessage('${finding.id}')">Send</button>
                    </div>
                </div>
                
                <div id="pocSection" style="display: none; margin-top: 20px;">
                    <h3>üî¨ Generated Proof of Concept</h3>
                    <div id="pocContent" style="background: #1a1a1a; padding: 15px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; border-left: 3px solid #ff0000;">
                        <!-- PoC will appear here -->
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }
        
        // Browser controls
        function startBrowser() {
            showNotification('üöÄ Starting browser...', 'success');
            
            fetch('/api/browser/start', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(`‚úÖ ${data.message}`, 'success');
                    } else {
                        showNotification(`‚ùå ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    showNotification('‚ùå Failed to start browser: ' + error.message, 'error');
                });
        }
        
        function testProxy() {
            showNotification('üîç Testing proxy connection...', 'success');
            
            fetch('/api/browser/test', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('‚úÖ Proxy test successful', 'success');
                    } else {
                        showNotification(`‚ùå ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    showNotification('‚ùå Proxy test failed: ' + error.message, 'error');
                });
        }
        
        // Data management
        function exportRequests() {
            const data = JSON.stringify(allRequests, null, 2);
            downloadJSON(data, 'vulna_requests.json');
        }
        
        function exportFindings() {
            const data = JSON.stringify(allFindings, null, 2);
            downloadJSON(data, 'vulna_findings.json');
        }
        
        function downloadJSON(data, filename) {
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function clearData() {
            if (confirm('Are you sure you want to clear all data?')) {
                fetch('/api/clear', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification(data.message, 'success');
                        } else {
                            showNotification(data.message, 'error');
                        }
                    });
            }
        }
        
        function refreshData() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    stats = data;
                    updateStats();
                });
                
            fetch('/api/requests')
                .then(response => response.json())
                .then(data => {
                    allRequests = data;
                    updateRequests();
                });
                
            fetch('/api/findings')
                .then(response => response.json())
                .then(data => {
                    allFindings = data;
                    updateFindings();
                });
        }
        
        // AI Functions - SAFE VERSIONS
        function openAIChat(vulnId) {
            const chatSection = document.getElementById('aiChatSection');
            chatSection.style.display = chatSection.style.display === 'none' ? 'block' : 'none';
            
            if (chatSection.style.display === 'block') {
                document.getElementById('chatInput').focus();
                // Restore previous chat history
                restoreChatHistory(vulnId);
            }
        }
        
        function sendAIMessage(vulnId) {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const chatHistory = document.getElementById('chatHistory');
            
            // Add user message safely
            const userDiv = document.createElement('div');
            userDiv.style.marginBottom = '10px';
            userDiv.style.textAlign = 'right';
            userDiv.innerHTML = `<strong style="color: #00ff00;">You:</strong> `;
            userDiv.appendChild(document.createTextNode(message));
            chatHistory.appendChild(userDiv);
            
            input.value = '';
            
            // Save user message to database
            saveSessionData(vulnId, 'chat', {
                type: 'user',
                content: message,
                metadata: { timestamp: new Date().toISOString() }
            });
            
            // Add loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'aiLoading';
            loadingDiv.style.marginBottom = '10px';
            loadingDiv.innerHTML = '<strong style="color: #0088ff;">AI:</strong> <em>Thinking...</em>';
            chatHistory.appendChild(loadingDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            // Send to AI
            fetch(`/api/vulnerability/${vulnId}/chat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
                loadingDiv.remove();
                
                const responseDiv = document.createElement('div');
                responseDiv.style.marginBottom = '15px';
                responseDiv.innerHTML = '<strong style="color: #0088ff;">AI:</strong>';
                
                const contentDiv = document.createElement('div');
                contentDiv.style.background = '#2d2d2d';
                contentDiv.style.padding = '10px';
                contentDiv.style.borderRadius = '5px';
                contentDiv.style.marginTop = '5px';
                contentDiv.style.whiteSpace = 'pre-wrap';
                contentDiv.style.borderLeft = '3px solid #0088ff';
                contentDiv.textContent = data.success ? data.ai_response : `Error: ${data.message}`;
                
                responseDiv.appendChild(contentDiv);
                chatHistory.appendChild(responseDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight;
                
                // Save AI response to database
                if (data.success) {
                    saveSessionData(vulnId, 'chat', {
                        type: 'ai',
                        content: data.ai_response,
                        metadata: { timestamp: new Date().toISOString() }
                    });
                }
            })
            .catch(error => {
                loadingDiv.remove();
                const errorDiv = document.createElement('div');
                errorDiv.style.marginBottom = '10px';
                errorDiv.innerHTML = '<strong style="color: #ff0000;">Error:</strong> ';
                errorDiv.appendChild(document.createTextNode(error.message));
                chatHistory.appendChild(errorDiv);
            });
        }
        
        function generatePoC(vulnId) {
            const pocSection = document.getElementById('pocSection');
            const pocContent = document.getElementById('pocContent');
            
            pocSection.style.display = 'block';
            
            // First, try to load existing PoC from database
            loadSessionData(vulnId).then(sessionData => {
                if (sessionData && sessionData.poc_code) {
                    pocContent.textContent = sessionData.poc_code;
                    showNotification('‚úÖ Loaded existing PoC from database', 'success');
                    return;
                }
                
                // Generate new PoC if none exists
                pocContent.textContent = 'Generating Proof of Concept... üîÑ';
                
                fetch(`/api/vulnerability/${vulnId}/generate-poc`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    pocContent.textContent = data.success ? data.proof_of_concept : `‚ùå PoC Generation Failed: ${data.message}`;
                    showNotification(data.success ? '‚úÖ PoC generated!' : '‚ùå PoC generation failed', data.success ? 'success' : 'error');
                    
                    // Save generated PoC to database
                    if (data.success) {
                        saveSessionData(vulnId, 'poc', {
                            poc_code: data.proof_of_concept
                        });
                    }
                })
                .catch(error => {
                    pocContent.textContent = `‚ùå Error: ${error.message}`;
                    showNotification('‚ùå PoC generation error', 'error');
                });
            });
        }
        
        function analyzeExploitation(vulnId) {
            // Create safe analysis section
            let exploitSection = document.getElementById('exploitAnalysisSection');
            if (!exploitSection) {
                const modalContent = document.getElementById('modalContent');
                exploitSection = document.createElement('div');
                exploitSection.id = 'exploitAnalysisSection';
                exploitSection.style.marginTop = '20px';
                exploitSection.innerHTML = `
                    <h3>üîç Exploitation Analysis</h3>
                    <div id="exploitContent" style="background: #1a1a1a; padding: 15px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; border-left: 3px solid #ffff00; max-height: 400px; overflow-y: auto;">
                        Analyzing exploitation vectors... üîÑ
                    </div>
                `;
                modalContent.appendChild(exploitSection);
            } else {
                exploitSection.style.display = 'block';
            }
            
            const exploitContent = document.getElementById('exploitContent');
            exploitContent.textContent = 'Analyzing attack vectors and exploitation methods... üîÑ';
            
            fetch(`/api/vulnerability/${vulnId}/analyze-exploitation`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.exploitation_analysis) {
                    exploitContent.textContent = data.exploitation_analysis;
                    exploitContent.style.borderLeftColor = '#ffff00';
                } else {
                    exploitContent.textContent = `‚ùå Analysis failed: ${data.message || 'Unknown error'}`;
                    exploitContent.style.borderLeftColor = '#ff0000';
                }
            })
            .catch(error => {
                exploitContent.textContent = `‚ùå Network Error: ${error.message}`;
                exploitContent.style.borderLeftColor = '#ff0000';
            });
        }
        
        function autoTestVulnerability(vulnId) {
            // Create safe auto test section
            let autoTestSection = document.getElementById('autoTestSection');
            if (!autoTestSection) {
                const modalContent = document.getElementById('modalContent');
                autoTestSection = document.createElement('div');
                autoTestSection.id = 'autoTestSection';
                autoTestSection.style.marginTop = '20px';
                autoTestSection.innerHTML = `
                    <h3>‚ö° Automated Vulnerability Testing</h3>
                    <div id="autoTestContent" style="background: #1a1a1a; padding: 15px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; border-left: 3px solid #00ff00; max-height: 400px; overflow-y: auto;">
                        Loading previous test results... üîÑ
                    </div>
                `;
                modalContent.appendChild(autoTestSection);
            } else {
                autoTestSection.style.display = 'block';
            }
            
            const autoTestContent = document.getElementById('autoTestContent');
            
            // First, try to load existing test results
            loadSessionData(vulnId).then(sessionData => {
                if (sessionData && sessionData.auto_test_results) {
                    autoTestContent.textContent = sessionData.auto_test_results;
                    autoTestContent.style.borderLeftColor = '#00ff00';
                    showNotification('‚úÖ Loaded previous auto-test results', 'success');
                    return;
                }
                
                // Run new auto-test if no previous results
                autoTestContent.textContent = 'Performing automated vulnerability testing... üîÑ';
                
                fetch(`/api/vulnerability/${vulnId}/auto-test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && data.automated_analysis) {
                        autoTestContent.textContent = data.automated_analysis;
                        autoTestContent.style.borderLeftColor = '#00ff00';
                        
                        // Save test results to database
                        saveSessionData(vulnId, 'auto_test', {
                            results: data.automated_analysis
                        });
                    } else {
                        autoTestContent.textContent = `‚ùå Auto-test failed: ${data.message || 'Unknown error'}`;
                        autoTestContent.style.borderLeftColor = '#ff0000';
                    }
                })
                .catch(error => {
                    autoTestContent.textContent = `‚ùå Network Error: ${error.message}`;
                    autoTestContent.style.borderLeftColor = '#ff0000';
                });
            });
        }
        
        function openLogView(vulnId) {
            // Create or show log view section
            let logViewSection = document.getElementById('logViewSection');
            if (!logViewSection) {
                const modalContent = document.getElementById('modalContent');
                logViewSection = document.createElement('div');
                logViewSection.id = 'logViewSection';
                logViewSection.style.marginTop = '20px';
                logViewSection.innerHTML = `
                    <h3>üìä AI Testing Log View</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button class="btn" onclick="startLiveLog('${vulnId}')" id="startLogBtn">üî¥ Start Live Log</button>
                        <button class="btn" onclick="stopLiveLog()" id="stopLogBtn" style="display: none;">‚èπÔ∏è Stop Log</button>
                        <button class="btn" onclick="clearLogView()">üóëÔ∏è Clear Log</button>
                        <button class="btn" onclick="exportLog()">üíæ Export Log</button>
                    </div>
                    <div id="logContent" style="background: #000; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; white-space: pre-wrap; border: 1px solid #00ff00; max-height: 500px; overflow-y: auto; font-size: 12px; color: #00ff00;">
                        üîç Log View Ready - Click "Start Live Log" to begin monitoring AI testing activities...
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #888;">
                        üí° This log shows real-time AI model activities: POC generation, testing payloads, analysis results, etc.
                    </div>
                `;
                modalContent.appendChild(logViewSection);
            } else {
                logViewSection.style.display = 'block';
            }
        }
        
        let logWebSocket = null;
        let isLogging = false;
        
        function startLiveLog(vulnId) {
            if (isLogging) return;
            
            isLogging = true;
            const startBtn = document.getElementById('startLogBtn');
            const stopBtn = document.getElementById('stopLogBtn');
            const logContent = document.getElementById('logContent');
            
            startBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';
            
            // Clear previous content
            logContent.textContent = 'üî¥ Live Log Started - Monitoring AI activities...\n\n';
            
            // Connect to log WebSocket
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/ws/logs/${vulnId}`;
            
            logWebSocket = new WebSocket(wsUrl);
            
            logWebSocket.onopen = function() {
                appendToLog('üü¢ Log connection established\n');
            };
            
            logWebSocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.type === 'log') {
                    const timestamp = new Date().toLocaleTimeString();
                    appendToLog(`[${timestamp}] ${data.message}\n`);
                }
            };
            
            logWebSocket.onclose = function() {
                appendToLog('üî¥ Log connection closed\n');
                stopLiveLog();
            };
            
            logWebSocket.onerror = function(error) {
                appendToLog(`‚ùå Log connection error: ${error}\n`);
            };
        }
        
        function stopLiveLog() {
            isLogging = false;
            const startBtn = document.getElementById('startLogBtn');
            const stopBtn = document.getElementById('stopLogBtn');
            
            startBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            
            if (logWebSocket) {
                logWebSocket.close();
                logWebSocket = null;
            }
            
            appendToLog('‚èπÔ∏è Live logging stopped\n');
        }
        
        function appendToLog(message) {
            const logContent = document.getElementById('logContent');
            if (logContent) {
                logContent.textContent += message;
                logContent.scrollTop = logContent.scrollHeight;
            }
        }
        
        function clearLogView() {
            const logContent = document.getElementById('logContent');
            if (logContent) {
                logContent.textContent = 'üìä Log cleared - Ready for new entries...\n\n';
            }
        }
        
        function exportLog() {
            const logContent = document.getElementById('logContent');
            if (logContent) {
                const logText = logContent.textContent;
                const blob = new Blob([logText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `vulna_log_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }
        
        function openRequestInspector(vulnId) {
            // Create or show request inspector section
            let inspectorSection = document.getElementById('requestInspectorSection');
            if (!inspectorSection) {
                const modalContent = document.getElementById('modalContent');
                inspectorSection = document.createElement('div');
                inspectorSection.id = 'requestInspectorSection';
                inspectorSection.style.marginTop = '20px';
                inspectorSection.innerHTML = `
                    <h3>üîç Request Inspector (Burp-Style)</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <h4>üì• Original Request</h4>
                            <textarea id="originalRequest" readonly style="width: 100%; height: 300px; background: #1a1a1a; color: #00ff00; font-family: monospace; border: 1px solid #333; padding: 10px; border-radius: 5px;">
Loading original request...
                            </textarea>
                        </div>
                        <div>
                            <h4>üìù Modified Request</h4>
                            <textarea id="modifiedRequest" style="width: 100%; height: 300px; background: #1a1a1a; color: #ffff00; font-family: monospace; border: 1px solid #333; padding: 10px; border-radius: 5px;">
Loading request for modification...
                            </textarea>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button class="btn" onclick="injectXSSPayload()">üö® Inject XSS</button>
                        <button class="btn" onclick="injectSQLPayload()">üíâ Inject SQL</button>
                        <button class="btn" onclick="sendModifiedRequest('${vulnId}')">üöÄ Send Request</button>
                        <button class="btn" onclick="exportToCurl()">üìã Export cURL</button>
                        <button class="btn" onclick="exportToBurp()">üîÑ Export Burp</button>
                    </div>
                    <div id="requestResponse" style="background: #1a1a1a; padding: 15px; border-radius: 5px; border: 1px solid #333; max-height: 200px; overflow-y: auto;">
                        <h4>üì§ Response</h4>
                        <div id="responseContent" style="font-family: monospace; color: #ccc;">
                            No response yet - modify and send request to see results
                        </div>
                    </div>
                `;
                modalContent.appendChild(inspectorSection);
                
                // Load original request data
                loadRequestData(vulnId);
            } else {
                inspectorSection.style.display = 'block';
            }
        }
        
        function loadRequestData(vulnId) {
            fetch(`/api/vulnerability/${vulnId}/request-data`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('originalRequest').value = data.original_request;
                    document.getElementById('modifiedRequest').value = data.original_request;
                }
            })
            .catch(error => {
                console.error('Error loading request data:', error);
            });
        }
        
        function injectXSSPayload() {
            const modifiedRequest = document.getElementById('modifiedRequest');
            const payload = '';
            // Simple injection - replace query parameters or add to body
            modifiedRequest.value = modifiedRequest.value.replace(/=[^&\s]*/g, `=${payload}`);
        }
        
        function injectSQLPayload() {
            const modifiedRequest = document.getElementById('modifiedRequest');
            const payload = "' OR 1=1 --";
            modifiedRequest.value = modifiedRequest.value.replace(/=[^&\s]*/g, `=${payload}`);
        }
        
        function sendModifiedRequest(vulnId) {
            const modifiedRequest = document.getElementById('modifiedRequest').value;
            const responseContent = document.getElementById('responseContent');
            
            responseContent.textContent = 'Sending modified request... üîÑ';
            
            fetch(`/api/vulnerability/${vulnId}/send-request`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ modified_request: modifiedRequest })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    responseContent.innerHTML = `
                        <div style="color: #00ff00;">‚úÖ Status: ${data.status_code}</div>
                        <div style="margin-top: 10px;">Headers: ${JSON.stringify(data.headers, null, 2)}</div>
                        <div style="margin-top: 10px;">Body: ${data.body.substring(0, 500)}${data.body.length > 500 ? '...' : ''}</div>
                    `;
                } else {
                    responseContent.innerHTML = `<div style="color: #ff0000;">‚ùå Error: ${data.message}</div>`;
                }
            })
            .catch(error => {
                responseContent.innerHTML = `<div style="color: #ff0000;">‚ùå Network Error: ${error.message}</div>`;
            });
        }
        
        function exportToCurl() {
            const modifiedRequest = document.getElementById('modifiedRequest').value;
            // Parse request and generate cURL command
            const lines = modifiedRequest.split('\n');
            const firstLine = lines[0];
            const [method, url] = firstLine.split(' ');
            
            let curlCommand = `curl -X ${method} "${url}"`;
            
            // Add headers
            for (let i = 1; i < lines.length && lines[i].trim() !== ''; i++) {
                if (lines[i].includes(':')) {
                    curlCommand += ` -H "${lines[i].trim()}"`;
                }
            }
            
            navigator.clipboard.writeText(curlCommand);
            alert('cURL command copied to clipboard!');
        }
        
        function exportToBurp() {
            const modifiedRequest = document.getElementById('modifiedRequest').value;
            // Simple Burp format export
            const burpFormat = `# Burp Suite Request Export\n# Generated by Vulna\n\n${modifiedRequest}`;
            
            const blob = new Blob([burpFormat], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'vulna_request_burp.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Vulnerability to Request Inspector functions
        function sendVulnToInspector(vulnId) {
            const vulnerability = allFindings.find(f => f.id === vulnId);
            if (!vulnerability) {
                showNotification('‚ùå Vulnerability not found', 'error');
                return;
            }
            
            const request = {
                method: vulnerability.request_method || 'GET',
                url: vulnerability.affected_url || vulnerability.url || '',
                headers: vulnerability.request_headers || {},
                body: vulnerability.request_body || '',
                timestamp: vulnerability.timestamp || new Date().toISOString(),
                vulnerability_context: {
                    id: vulnerability.id,
                    title: vulnerability.title,
                    risk_level: vulnerability.risk_level
                }
            };
            
            sendToInspector(request);
        }
        
        function createRequestFromVuln(vulnId) {
            const vulnerability = allFindings.find(f => f.id === vulnId);
            if (!vulnerability) {
                showNotification('‚ùå Vulnerability not found', 'error');
                return;
            }
            
            const testRequest = {
                method: vulnerability.request_method || 'POST',
                url: vulnerability.affected_url || vulnerability.url || '',
                headers: {
                    'Content-Type': 'application/json',
                    'User-Agent': 'Vulna-Tester/1.0',
                    ...(vulnerability.request_headers || {})
                },
                body: vulnerability.request_body || JSON.stringify({
                    test_param: 'vulnerability_test',
                    vuln_id: vulnerability.id
                }, null, 2),
                timestamp: new Date().toISOString()
            };
            
            sendToInspector(testRequest);
        }
        
        // Request Inspector & Tamper Functions
        function sendToInspector(request) {
            // Create Inspector Modal
            const inspectorModal = document.createElement('div');
            inspectorModal.className = 'modal';
            inspectorModal.style.display = 'block';
            inspectorModal.style.zIndex = '1002';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.style.maxWidth = '1200px';
            modalContent.style.height = '90vh';
            
            modalContent.innerHTML = `
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                <h2>üîç Request Inspector & Tamper Tool</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: calc(100% - 80px);">
                    <div>
                        <h3>üì• Original Request</h3>
                        <div style="background: #1a1a1a; padding: 15px; border-radius: 5px; height: 100%; overflow-y: auto; font-family: monospace; font-size: 12px;">
                            <div><strong>Method:</strong> ${request.method}</div>
                            <div><strong>URL:</strong> ${request.url}</div>
                            <div><strong>Headers:</strong></div>
                            <pre>${JSON.stringify(request.headers, null, 2)}</pre>
                            <div><strong>Body:</strong></div>
                            <pre>${request.body || 'No body'}</pre>
                        </div>
                    </div>
                    
                    <div>
                        <h3>üõ†Ô∏è Tamper Request</h3>
                        <div style="height: 100%; display: flex; flex-direction: column;">
                            <div style="margin-bottom: 10px;">
                                <label><strong>Method:</strong></label>
                                <select id="tamperMethod" style="background: #333; color: white; border: 1px solid #555; margin-left: 10px;">
                                    <option value="GET" ${request.method === 'GET' ? 'selected' : ''}>GET</option>
                                    <option value="POST" ${request.method === 'POST' ? 'selected' : ''}>POST</option>
                                    <option value="PUT" ${request.method === 'PUT' ? 'selected' : ''}>PUT</option>
                                    <option value="DELETE" ${request.method === 'DELETE' ? 'selected' : ''}>DELETE</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 10px;">
                                <label><strong>URL:</strong></label>
                                <input type="text" id="tamperUrl" value="${request.url}" 
                                       style="width: 100%; background: #333; color: white; border: 1px solid #555; padding: 5px; margin-top: 5px;">
                            </div>
                            
                            <div style="margin-bottom: 10px; flex: 1; display: flex; flex-direction: column;">
                                <label><strong>Headers:</strong></label>
                                <textarea id="tamperHeaders" style="flex: 1; background: #333; color: white; border: 1px solid #555; font-family: monospace; margin-top: 5px;">${JSON.stringify(request.headers, null, 2)}</textarea>
                            </div>
                            
                            <div style="margin-bottom: 10px; flex: 1; display: flex; flex-direction: column;">
                                <label><strong>Body:</strong></label>
                                <textarea id="tamperBody" style="flex: 1; background: #333; color: white; border: 1px solid #555; font-family: monospace; margin-top: 5px;">${request.body || ''}</textarea>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                                <button onclick="addPayloadToRequest('xss')" class="btn">üíâ Add XSS</button>
                                <button onclick="addPayloadToRequest('sql')" class="btn">üíâ Add SQL</button>
                                <button onclick="testTamperedRequest()" class="btn">üöÄ Test Request</button>
                                <button onclick="generateCurlFromTamper()" class="btn">üìã Generate cURL</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            inspectorModal.appendChild(modalContent);
            document.body.appendChild(inspectorModal);
        }
        
        // Payload injection functions
        function addPayloadToRequest(type) {
            const urlField = document.getElementById('tamperUrl');
            const bodyField = document.getElementById('tamperBody');
            
            let payload = '';
            let paramName = '';
            
            switch(type) {
                case 'xss':
                    payload = '';
                    paramName = 'xss_test';
                    break;
                case 'sql':
                    payload = "' OR '1'='1' --";
                    paramName = 'sql_test';
                    break;
            }
            
            // Add to URL parameters
            const url = urlField.value;
            if (url.includes('?')) {
                urlField.value = url + `&${paramName}=${encodeURIComponent(payload)}`;
            } else {
                urlField.value = url + `?${paramName}=${encodeURIComponent(payload)}`;
            }
            
            showNotification(`‚úÖ ${type.toUpperCase()} payload added to request`, 'success');
        }
        
        function testTamperedRequest() {
            const method = document.getElementById('tamperMethod').value;
            const url = document.getElementById('tamperUrl').value;
            const headers = document.getElementById('tamperHeaders').value;
            const body = document.getElementById('tamperBody').value;
            
            showNotification('üöÄ Testing tampered request...', 'success');
            
            fetch('/api/test-request', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    method: method,
                    url: url,
                    headers: JSON.parse(headers),
                    body: body
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`‚úÖ Response: ${data.status_code}`, 'success');
                } else {
                    showNotification(`‚ùå Request failed: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                showNotification(`‚ùå Network error: ${error.message}`, 'error');
            });
        }
        
        function generateCurlFromTamper() {
            const method = document.getElementById('tamperMethod').value;
            const url = document.getElementById('tamperUrl').value;
            const headers = document.getElementById('tamperHeaders').value;
            const body = document.getElementById('tamperBody').value;
            
            let curlCommand = `curl -X ${method}`;
            
            try {
                const headersObj = JSON.parse(headers);
                for (let [key, value] of Object.entries(headersObj)) {
                    curlCommand += ` -H "${key}: ${value}"`;
                }
            } catch (e) {
                console.error('Invalid headers JSON:', e);
            }
            
            if (body && body.trim() !== '') {
                curlCommand += ` -d '${body}'`;
            }
            
            curlCommand += ` "${url}"`;
            
            navigator.clipboard.writeText(curlCommand).then(() => {
                showNotification('üìã cURL command copied to clipboard!', 'success');
            });
        }
        
        // Session Management Functions
        function saveSessionData(vulnId, sessionType, data) {
            fetch(`/api/vulnerability/${vulnId}/save-session`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session_type: sessionType,
                    data: data
                })
            })
            .catch(error => console.error('Failed to save session data:', error));
        }
        
        function loadSessionData(vulnId) {
            return fetch(`/api/vulnerability/${vulnId}/session`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        return data;
                    }
                    throw new Error(data.message);
                })
                .catch(error => {
                    console.error('Failed to load session data:', error);
                    return null;
                });
        }
        
        function restoreChatHistory(vulnId) {
            const chatHistory = document.getElementById('chatHistory');
            if (!chatHistory) return;
            
            loadSessionData(vulnId).then(sessionData => {
                if (sessionData && sessionData.chat_history) {
                    chatHistory.innerHTML = '';
                    
                    sessionData.chat_history.forEach(message => {
                        const messageDiv = document.createElement('div');
                        messageDiv.style.marginBottom = '10px';
                        messageDiv.style.textAlign = message.type === 'user' ? 'right' : 'left';
                        
                        const header = message.type === 'user' ? 
                            '<strong style="color: #00ff00;">You:</strong> ' : 
                            '<strong style="color: #0088ff;">AI:</strong>';
                        
                        messageDiv.innerHTML = header;
                        
                        if (message.type === 'ai') {
                            const contentDiv = document.createElement('div');
                            contentDiv.style.background = '#2d2d2d';
                            contentDiv.style.padding = '10px';
                            contentDiv.style.borderRadius = '5px';
                            contentDiv.style.marginTop = '5px';
                            contentDiv.style.whiteSpace = 'pre-wrap';
                            contentDiv.style.borderLeft = '3px solid #0088ff';
                            contentDiv.textContent = message.content;
                            messageDiv.appendChild(contentDiv);
                        } else {
                            messageDiv.appendChild(document.createTextNode(message.content));
                        }
                        
                        chatHistory.appendChild(messageDiv);
                    });
                    
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                }
            });
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target === modal) {
                closeModal();
            }
        }
        
        // Initialize
        connectWebSocket();
        
        // Periodic refresh
        setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send('ping');
            }
        }, 30000);
    </script>
</body>
</html>